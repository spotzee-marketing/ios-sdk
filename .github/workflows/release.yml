name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Create Release
    runs-on: macos-14
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Validate iOS SDK Build
        run: |
          xcodebuild -scheme Spotzee \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -configuration Release \
            build

      - name: Get Version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Spotzee iOS SDK v${{ steps.version.outputs.version }}

            ### Installation

            **Swift Package Manager:**
            ```
            https://github.com/spotzee-marketing/ios-sdk
            ```

            **CocoaPods:**
            ```ruby
            pod 'Spotzee', '~> ${{ steps.version.outputs.version }}'
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-cocoapods:
    name: Publish to CocoaPods
    runs-on: macos-14
    needs: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Publish to CocoaPods Trunk
        run: pod trunk push Spotzee.podspec --allow-warnings
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
